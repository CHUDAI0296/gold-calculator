<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precious Metal Market Charts - Gold, Silver, Platinum Price History</title>
    <meta name="description" content="Track gold, silver, and platinum with interactive charts. Explore historical price data, moving averages, volatility, and trends to time purchases and refine pricing decisions with clear market context.">
    <link rel="canonical" href="https://www.goldcalculator.click/market.html" />
    <!-- Critical Resource Preloads -->
    <link rel="preload" href="css/styles.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" as="script">
    <!-- DNS Prefetch for performance -->
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//www.googletagmanager.com">
    <link rel="dns-prefetch" href="//pagead2.googlesyndication.com">
    <!-- Critical CSS Inline -->
    <style>
        :root{--gold-primary:#D4AF37;--gold-secondary:#FFD700;--gold-dark:#B8860B;--gold-light:#FFF8DC;--silver-primary:#C0C0C0;--platinum-primary:#E5E4E2}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;color:#333;margin:0}
        .navbar-brand{display:flex;align-items:center;font-weight:bold;font-size:1.5rem}
        .gold-icon{color:#FFD700;font-size:1.5rem;margin-right:10px}
        .silver-icon{color:var(--silver-primary);margin-right:8px}
        .platinum-icon{color:var(--platinum-primary);margin-right:8px}
        .price-box{font-size:2rem;font-weight:700;margin:1rem 0}
        .gold-price{color:var(--gold-dark)}
        .silver-price{color:var(--silver-primary)}
        .platinum-price{color:var(--platinum-primary)}
        .market-hero{background-color:#f8f9fa;padding:3rem 0}
        .chart-container{min-height:400px;position:relative}
        @media(max-width:768px){.price-box{font-size:1.5rem}}
    </style>

    <link rel="stylesheet" href="css/styles.css">
    <!-- Async CSS Loading -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"></noscript>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"></noscript>
    
    <!-- Baidu Analytics -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?3d4d36f5314954e7ca6dc33b6a81373b";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <script type='text/javascript' src='//pl28024779.effectivegatecpm.com/59/09/19/59091957719b6779cd1f4af7ac8b5068.js'></script>
    <!-- Microsoft Clarity -->
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "u3xxjqx9t5");
    </script>
</head>
<body>
    <!-- Header Section -->
    <header class="bg-dark text-white">
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-coins gold-icon"></i> Gold Calculator
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="/calculator">Calculator</a></li>
                        <li class="nav-item"><a class="nav-link active" href="/market">Market</a></li>
                        <li class="nav-item"><a class="nav-link" href="/metals">Metals</a></li>
                        <li class="nav-item"><a class="nav-link" href="/news">News</a></li>
                        <li class="nav-item"><a class="nav-link" href="/faq">FAQ</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- Market Hero Section -->
    <section class="market-hero py-5 bg-light">
        <div class="container text-center">
            <h1 class="display-4">Precious Metal Market Charts</h1>
            <p class="lead">Track historical prices and market trends</p>
            
            <!-- Current Prices Display -->
            <div class="row mt-4">
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3>Gold <i class="fas fa-coins gold-icon"></i></h3>
                            <div class="price-box gold-price">
                                <span id="current-gold-price">Loading...</span> USD/oz
                            </div>
                            <div class="price-change" id="gold-price-change">
                                <span class="change-value">--</span>
                                <span class="change-percent">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3>Silver <i class="fas fa-coins silver-icon"></i></h3>
                            <div class="price-box silver-price">
                                <span id="current-silver-price">Loading...</span> USD/oz
                            </div>
                            <div class="price-change" id="silver-price-change">
                                <span class="change-value">--</span>
                                <span class="change-percent">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3>Platinum <i class="fas fa-coins platinum-icon"></i></h3>
                            <div class="price-box platinum-price">
                                <span id="current-platinum-price">Loading...</span> USD/oz
                            </div>
                            <div class="price-change" id="platinum-price-change">
                                <span class="change-value">--</span>
                                <span class="change-percent">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <p class="small text-muted mt-2">Last updated: <span id="last-updated">Loading...</span></p>
            <div class="mt-2">
                <div id="display-mode-group" class="btn-group btn-group-sm" role="group" aria-label="Display mode">
                    <button type="button" class="btn btn-outline-secondary" data-mode="spot">现货显示</button>
                    <button type="button" class="btn btn-outline-secondary" data-mode="cfd">CFD显示</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Chart Section -->
    <section class="chart-section py-5">
        <div class="container">
            <div class="card mb-4">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h2 class="mb-0">Gold Price History</h2>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <!-- Time Range Selector -->
                            <div class="btn-group" role="group" aria-label="Time range selector">
                                <button type="button" class="btn btn-outline-primary time-range-btn active" data-range="7">7 Days</button>
                                <button type="button" class="btn btn-outline-primary time-range-btn" data-range="30">30 Days</button>
                                <button type="button" class="btn btn-outline-primary time-range-btn" data-range="90">90 Days</button>
                                <button type="button" class="btn btn-outline-primary time-range-btn" data-range="365">1 Year</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="priceHistoryTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Gold (USD/oz)</th>
                                    <th>Silver (USD/oz)</th>
                                    <th>Platinum (USD/oz)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div class="text-muted small" id="tableNote"></div>
                    </div>
                </div>
            </div>
            <div class="card mb-4">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h2 class="mb-0">Trading Chart</h2>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <div class="btn-group" role="group" aria-label="Trading range selector">
                                <button type="button" class="btn btn-outline-secondary trading-range-btn active" data-days="30">30 Days</button>
                                <button type="button" class="btn btn-outline-secondary trading-range-btn" data-days="90">90 Days</button>
                                <button type="button" class="btn btn-outline-secondary trading-range-btn" data-days="365">1 Year</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="tradingChart" style="height: 420px; position: relative;"></div>
                    <div class="text-muted small">Data source: Yahoo Finance GC=F via backend</div>
                </div>
            </div>
            
            <!-- Metal Selection -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="mb-0">Select Metals to Display</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="showGold" checked>
                                <label class="form-check-label" for="showGold">
                                    <i class="fas fa-circle gold-icon"></i> Gold
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="showSilver" checked>
                                <label class="form-check-label" for="showSilver">
                                    <i class="fas fa-circle silver-icon"></i> Silver
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="showPlatinum" checked>
                                <label class="form-check-label" for="showPlatinum">
                                    <i class="fas fa-circle platinum-icon"></i> Platinum
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Market Analysis -->
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h3 class="mb-0">Market Analysis</h3>
                        </div>
                        <div class="card-body">
                            <h4>Current Trends</h4>
                            <p>The precious metals market has shown significant volatility in recent months. Gold prices have been influenced by global economic uncertainty, inflation concerns, and central bank policies.</p>
                            
                            <h4>Key Factors Affecting Prices</h4>
                            <ul>
                                <li>Global economic conditions</li>
                                <li>Inflation rates and expectations</li>
                                <li>Interest rate policies</li>
                                <li>Currency fluctuations</li>
                                <li>Geopolitical tensions</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h3 class="mb-0">Metal Comparison</h3>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Metal</th>
                                        <th>YTD Change</th>
                                        <th>1-Year High</th>
                                        <th>1-Year Low</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><i class="fas fa-circle gold-icon"></i> Gold</td>
                                        <td id="gold-ytd">+5.2%</td>
                                        <td id="gold-high">$2,074.88</td>
                                        <td id="gold-low">$1,810.20</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-circle silver-icon"></i> Silver</td>
                                        <td id="silver-ytd">+3.8%</td>
                                        <td id="silver-high">$27.50</td>
                                        <td id="silver-low">$22.10</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-circle platinum-icon"></i> Platinum</td>
                                        <td id="platinum-ytd">-2.1%</td>
                                        <td id="platinum-high">$1,150.00</td>
                                        <td id="platinum-low">$890.30</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle"></i> These figures are for demonstration purposes. In a production environment, they would be updated with real market data.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Price Alert Section -->
    <section class="alert-section py-5 bg-light">
        <div class="container">
            <div class="row">
                <div class="col-md-6 offset-md-3 text-center">
                    <h2 class="mb-4">Get Price Alerts</h2>
                    <p>Sign up to receive email notifications when precious metal prices reach your target levels.</p>
                    <a href="#" class="btn btn-primary">Coming Soon</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Related Links -->
    <section class="py-5 bg-light">
        <div class="container">
            <h2 class="h5 mb-4">Related links</h2>
            <div class="row g-3">
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="h6">Calculators</h3>
                            <ul class="mb-0">
                                <li><a href="calculator.html">Gold Calculator</a></li>
                                <li><a href="metals.html">Silver & Platinum Calculator</a></li>
                                <li><a href="multi-calculator.html">Batch Calculator</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="h6">Helpful links</h3>
                            <ul class="mb-0">
                                <li><a href="/calculator">Gold Calculator</a></li>
                                <li><a href="/faq">FAQ</a></li>
                                <li><a href="/contact">Contact</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="h6">Market & insights</h3>
                            <ul class="mb-0">
                                <li><a href="market.html">Market Price Charts</a></li>
                                <li><a href="blog.html">Blog</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="h6">Support</h3>
                            <ul class="mb-0">
                                <li><a href="faq.html">FAQ</a></li>
                                <li><a href="contact.html">Contact</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 col-md-6 mb-4">
                    <h5 class="mb-3"><i class="fas fa-coins gold-icon"></i> Gold Calculator</h5>
                    <p>Professional gold and silver calculator for jewelry valuation and precious metal investments. Get accurate estimates based on real-time market prices.</p>
                    <div class="social-icons mt-3">
                        <a href="#" class="text-white me-3"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h5 class="mb-3">Quick Links</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="index.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Home</a></li>
                        <li class="mb-2"><a href="calculator.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Gold Calculator</a></li>
                        <li class="mb-2"><a href="metals.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Other Metals</a></li>
                        <li class="mb-2"><a href="market.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Market Charts</a></li>
                        <li class="mb-2"><a href="multi-calculator.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Batch Calculator</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <h5 class="mb-3">Resources</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="gold-education.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Gold Education</a></li>
                        <li class="mb-2"><a href="silver-guide.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Silver Market Analysis</a></li>
                        <li class="mb-2"><a href="investment-guide.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Investment Guide</a></li>
                        <li class="mb-2"><a href="gold-history.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Gold Price History</a></li>
                        <li class="mb-2"><a href="blog.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Blog</a></li>
                        <li class="mb-2"><a href="refining-services.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Refining Services</a></li>
                        <li class="mb-2"><a href="dealer-program.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Dealer Program</a></li>
                        <li class="mb-2"><a href="coin-melt-values.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Coin Melt Values</a></li>
                        <li class="mb-2"><a href="live-karat-prices.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Live Karat Prices</a></li>
                        <li class="mb-2"><a href="faq.html" class="text-white"><i class="fas fa-angle-right me-2"></i>FAQ</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <h5 class="mb-3">Contact & Legal</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-envelope me-2"></i> <a href="mailto:chudai@oldphotorestoration.site" class="text-white">chudai@oldphotorestoration.site</a></li>
                        <li class="mb-2"><i class="fas fa-phone me-2"></i> +86 19207810296</li>
                        <li class="mb-2"><i class="fas fa-location-dot me-2"></i> Guangxi, China</li>
                        <li class="mb-2"><a href="contact.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Contact Us</a></li>
                        <li class="mb-2"><a href="about.html" class="text-white"><i class="fas fa-angle-right me-2"></i>About Us</a></li>
                        <li class="mb-2"><a href="privacy.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Privacy Policy</a></li>
                        <li class="mb-2"><a href="terms.html" class="text-white"><i class="fas fa-angle-right me-2"></i>Terms of Service</a></li>
                    </ul>
                </div>
            </div>
            <hr class="my-4 bg-secondary">
            <div class="row align-items-center">
                <div class="col-md-7">
                    <p class="mb-md-0">&copy; <span id="copyright-year">2023</span> Chudai. All rights reserved.</p>
                </div>
                <div class="col-md-5 text-md-end">
                    <p class="small mb-0">Disclaimer: Gold and silver prices are indicative and for reference purposes only. Actual market prices may vary.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Optimized JS Loading -->
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="js/gold-api.js?v=20251116"></script>

    <!-- Inline Ultra Lightweight Chart - Zero dependencies -->
    <script>
        // Ultra lightweight chart implementation
        class SimpleChart {
            constructor(canvasId, options = {}) {
                this.canvas = document.getElementById(canvasId);
                if (!this.canvas) return null;
                
                this.ctx = this.canvas.getContext('2d');
                this.options = {
                    lineColor: '#D4AF37',
                    pointColor: '#FFD700',
                    backgroundColor: '#ffffff',
                    gridColor: '#e0e0e0',
                    basePrice: 2000,
                    ...options
                };
                this.days = options.initialDays || 7;
                
                this.data = [];
                this.init();
            }
            
            init() {
                this.generateData(this.days);
                this.setupCanvas();
                this.draw();
                
                // Auto-update every 30 seconds
                setInterval(() => {
                    this.updateData();
                    this.draw();
                }, 30000);
            }
            
            setupCanvas() {
                const container = this.canvas.parentElement;
                const rect = container.getBoundingClientRect();
                
                this.canvas.width = rect.width;
                this.canvas.height = rect.height || 400;
                
                const dpr = window.devicePixelRatio || 1;
                this.canvas.width = this.canvas.width * dpr;
                this.canvas.height = this.canvas.height * dpr;
                this.ctx.scale(dpr, dpr);
                
                this.canvas.style.width = rect.width + 'px';
                this.canvas.style.height = (rect.height || 400) + 'px';
                
                window.addEventListener('resize', () => {
                    this.setupCanvas();
                    this.draw();
                });
            }
            
            generateData(days = 30) {
                const now = new Date();
                this.data = [];
                
                for (let i = days; i >= 0; i--) {
                    const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                    const trend = Math.sin((days - i) / days * Math.PI * 2) * 50;
                    const noise = (Math.random() - 0.5) * 30;
                    const price = this.options.basePrice + trend + noise;
                    
                    this.data.push({
                        date: date.toISOString().split('T')[0],
                        price: Math.max(1000, price),
                        label: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                    });
                }
            }
            
            updateData() {
                const lastDate = new Date(this.data[this.data.length - 1].date);
                const newDate = new Date(lastDate.getTime() + 24 * 60 * 60 * 1000);
                const lastPrice = this.data[this.data.length - 1].price;
                const change = (Math.random() - 0.5) * 20;
                const newPrice = Math.max(1000, lastPrice + change);
                
                this.data.push({
                    date: newDate.toISOString().split('T')[0],
                    price: newPrice,
                    label: newDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                });
                
                if (this.data.length > 31) {
                    this.data.shift();
                }
            }

            setRange(days) {
                this.days = days;
                this.generateData(days);
                this.draw();
            }
            
            draw() {
                if (!this.ctx || !this.data.length) return;
                
                const width = this.canvas.width / (window.devicePixelRatio || 1);
                const height = this.canvas.height / (window.devicePixelRatio || 1);
                
                this.ctx.clearRect(0, 0, width, height);
                this.ctx.fillStyle = this.options.backgroundColor;
                this.ctx.fillRect(0, 0, width, height);
                
                this.drawGrid(width, height);
                this.drawLine(width, height);
                this.drawLabels(width, height);
                this.drawCurrentPrice(width, height);
            }
            
            drawGrid(width, height) {
                this.ctx.strokeStyle = this.options.gridColor;
                this.ctx.lineWidth = 1;
                
                for (let i = 0; i <= 5; i++) {
                    const y = (height - 80) * (i / 5) + 40;
                    this.ctx.beginPath();
                    this.ctx.moveTo(60, y);
                    this.ctx.lineTo(width - 20, y);
                    this.ctx.stroke();
                }
                
                const step = Math.max(1, Math.floor(this.data.length / 6));
                for (let i = 0; i < this.data.length; i += step) {
                    const x = 60 + (width - 80) * (i / (this.data.length - 1));
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 40);
                    this.ctx.lineTo(x, height - 40);
                    this.ctx.stroke();
                }
            }
            
            drawLine(width, height) {
                if (this.data.length < 2) return;
                
                const chartWidth = width - 80;
                const chartHeight = height - 100;
                const minPrice = Math.min(...this.data.map(d => d.price));
                const maxPrice = Math.max(...this.data.map(d => d.price));
                const priceRange = maxPrice - minPrice || 1;
                
                this.ctx.strokeStyle = this.options.lineColor;
                this.ctx.lineWidth = 3;
                this.ctx.beginPath();
                
                this.data.forEach((point, index) => {
                    const x = 60 + chartWidth * (index / (this.data.length - 1));
                    const y = 50 + chartHeight * (1 - (point.price - minPrice) / priceRange);
                    
                    if (index === 0) {
                        this.ctx.moveTo(x, y);
                    } else {
                        this.ctx.lineTo(x, y);
                    }
                });
                
                this.ctx.stroke();
                
                this.ctx.fillStyle = this.options.pointColor;
                this.data.forEach((point, index) => {
                    const x = 60 + chartWidth * (index / (this.data.length - 1));
                    const y = 50 + chartHeight * (1 - (point.price - minPrice) / priceRange);
                    
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, 4, 0, 2 * Math.PI);
                    this.ctx.fill();
                });
            }
            
            drawLabels(width, height) {
                this.ctx.fillStyle = this.options.textColor || '#333';
                this.ctx.font = '12px Arial';
                this.ctx.textAlign = 'center';
                
                const step = Math.max(1, Math.floor(this.data.length / 6));
                this.data.forEach((point, index) => {
                    if (index % step === 0) {
                        const x = 60 + (width - 80) * (index / (this.data.length - 1));
                        this.ctx.fillText(point.label, x, height - 15);
                    }
                });
                
                this.ctx.textAlign = 'right';
                const minPrice = Math.min(...this.data.map(d => d.price));
                const maxPrice = Math.max(...this.data.map(d => d.price));
                
                for (let i = 0; i <= 5; i++) {
                    const price = minPrice + (maxPrice - minPrice) * (1 - i / 5);
                    const y = (height - 100) * (i / 5) + 55;
                    this.ctx.fillText('$' + price.toFixed(2), 55, y);
                }
            }
            
            drawCurrentPrice(width, height) {
                if (this.data.length === 0) return;
                
                const currentPrice = this.data[this.data.length - 1].price;
                const minPrice = Math.min(...this.data.map(d => d.price));
                const maxPrice = Math.max(...this.data.map(d => d.price));
                const priceRange = maxPrice - minPrice || 1;
                
                const x = 60 + (width - 80) * ((this.data.length - 1) / (this.data.length - 1));
                const y = 50 + (height - 100) * (1 - (currentPrice - minPrice) / priceRange);
                
                this.ctx.fillStyle = '#ff6b6b';
                this.ctx.beginPath();
                this.ctx.arc(x, y, 6, 0, 2 * Math.PI);
                this.ctx.fill();
                
                this.ctx.fillStyle = '#ff6b6b';
                this.ctx.font = 'bold 14px Arial';
                this.ctx.textAlign = 'left';
                this.ctx.fillText('$' + currentPrice.toFixed(2), x + 15, y + 5);
            }
        }
        
        // Initialize table when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof fetchHistoryDays !== 'function') {
                window.fetchHistoryDays = async function(metalSymbol, days){
                    const end = new Date();
                    const start = new Date(end.getTime() - days*24*60*60*1000);
                    const startStr = start.toISOString().slice(0,10);
                    const endStr = end.toISOString().slice(0,10);
                    try {
                        const r = await fetch(`/api/timeseries?start_date=${startStr}&end_date=${endStr}&metal=${metalSymbol}`);
                        if (r.ok) { const d = await r.json(); if (Array.isArray(d)) return d; }
                    } catch(e) {}
                    try {
                        const r2 = await fetch(`https://api.exchangerate.host/timeseries?start_date=${startStr}&end_date=${endStr}&base=${metalSymbol}&symbols=USD`);
                        const d2 = await r2.json(); const out = []; if (d2 && d2.rates){ Object.keys(d2.rates).sort().forEach(k=>{ const v=d2.rates[k]&&d2.rates[k].USD; if (v){ const ts=new Date(k).getTime()/1000; out.push({ price: parseFloat(v), timestamp: ts, date: new Date(ts*1000).toISOString()}); } }); }
                        return out;
                    } catch(e){ return []; }
                }
            }
            async function renderTable(days){
                const [gRows, sRows, pRows] = await Promise.all([
                    fetchHistoryDays('XAU', days),
                    fetchHistoryDays('XAG', days),
                    fetchHistoryDays('XPT', days)
                ]);
                const tbody = document.querySelector('#priceHistoryTable tbody');
                const note = document.getElementById('tableNote');
                tbody.innerHTML = '';
                if ((!gRows || gRows.length === 0) && (!sRows || sRows.length === 0) && (!pRows || pRows.length === 0)){
                    note.textContent = 'No historical data available for the selected period from the provider.';
                    return;
                }
                note.textContent = '';
                const byDate = new Map();
                function addRows(rows, key){
                    rows.forEach(r=>{
                        const d = new Date(r.timestamp*1000); const dateStr = d.toLocaleDateString();
                        if (!byDate.has(dateStr)) byDate.set(dateStr, { dateStr });
                        byDate.get(dateStr)[key] = parseFloat(r.price);
                    });
                }
                addRows(gRows,'gold'); addRows(sRows,'silver'); addRows(pRows,'platinum');
                Array.from(byDate.keys()).sort((a,b)=> new Date(a)-new Date(b)).forEach(dateStr=>{
                    const item = byDate.get(dateStr);
                    const tr = document.createElement('tr');
                    const td1 = document.createElement('td'); td1.textContent = dateStr; tr.appendChild(td1);
                    const td2 = document.createElement('td'); td2.textContent = item.gold ? (typeof formatGoldPrice==='function'?formatGoldPrice(item.gold):('$'+item.gold.toFixed(2))) : '--'; tr.appendChild(td2);
                    const td3 = document.createElement('td'); td3.textContent = item.silver ? (typeof formatGoldPrice==='function'?formatGoldPrice(item.silver):('$'+item.silver.toFixed(2))) : '--'; tr.appendChild(td3);
                    const td4 = document.createElement('td'); td4.textContent = item.platinum ? (typeof formatGoldPrice==='function'?formatGoldPrice(item.platinum):('$'+item.platinum.toFixed(2))) : '--'; tr.appendChild(td4);
                    tbody.appendChild(tr);
                });
                try { if (typeof gtag === 'function') { gtag('event', 'table_range_change', { event_category: 'chart', range_days: days }); } } catch (err) {}
            }

            renderTable(7);

            async function updateCards(){
                try {
                    const [gp, sp, pp] = await Promise.all([
                        getCurrentGoldPrice(), getCurrentSilverPrice(), getCurrentPlatinumPrice()
                    ]);
                    const goldEl = document.getElementById('current-gold-price');
                    const silverEl = document.getElementById('current-silver-price');
                    const platinumEl = document.getElementById('current-platinum-price');
                    if (goldEl && gp) goldEl.textContent = (typeof formatGoldPrice==='function'?formatGoldPrice(gp):('$'+gp.toFixed(2)));
                    if (silverEl && sp) silverEl.textContent = (typeof formatGoldPrice==='function'?formatGoldPrice(sp):('$'+sp.toFixed(2)));
                    if (platinumEl && pp) platinumEl.textContent = (typeof formatGoldPrice==='function'?formatGoldPrice(pp):('$'+pp.toFixed(2)));
                    const lu = document.getElementById('last-updated');
                    if (lu) lu.textContent = localStorage.getItem('lastUpdated') || new Date().toLocaleString();
                } catch(e) {}
            }
            updateCards();

            const timeRangeContainer = document.querySelector('.btn-group');
            if (timeRangeContainer) {
                timeRangeContainer.addEventListener('click', function(e) {
                    if (e.target.classList.contains('time-range-btn')) {
                        timeRangeContainer.querySelectorAll('.time-range-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        const range = parseInt(e.target.getAttribute('data-range'), 10);
                        if (!isNaN(range)) {
                            renderTable(range);
                        }
                    }
                });
            }
            // Trading chart
            function initTradingChart(days){
                if (!window.LightweightCharts) return;
                if (window.tvChart) { window.tvChart.remove(); }
                const chart = LightweightCharts.createChart(document.getElementById('tradingChart'), {
                    width: document.getElementById('tradingChart').clientWidth,
                    height: 420,
                    layout: { background: { color: '#ffffff' }, textColor: '#333' },
                    grid: { vertLines: { color: '#eee' }, horzLines: { color: '#eee' } },
                    timeScale: { borderColor: '#ccc' },
                    rightPriceScale: { borderColor: '#ccc' }
                });
                const candleSeries = chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350', borderDownColor: '#ef5350', borderUpColor: '#26a69a', wickDownColor: '#ef5350', wickUpColor: '#26a69a' });
                fetch(`/api/gold/candles?days=${days}`).then(r=>{
                    if (!r.ok) throw new Error('backend');
                    return r.json();
                }).then(data=>{
                    const m = (typeof getDisplayMultiplier==='function')?getDisplayMultiplier():1;
                    const candles = data.map(d=>({ time: d.time, open: d.open*m, high: d.high*m, low: d.low*m, close: d.close*m }));
                    candleSeries.setData(candles);
                    window.tvChart = chart;
                }).catch(()=>{
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/GC=F?range=1mo&interval=1d&includePrePost=false`;
                    fetch(url).then(rr=>rr.json()).then(dd=>{
                        const res = dd && dd.chart && dd.chart.result && dd.chart.result[0];
                        const ts = res ? res.timestamp : [];
                        const q = res && res.indicators && res.indicators.quote && res.indicators.quote[0] || {};
                        const m = (typeof getDisplayMultiplier==='function')?getDisplayMultiplier():1;
                        const out = []; for (let i=0;i<(ts||[]).length;i++){ const o=q.open&&q.open[i],h=q.high&&q.high[i],l=q.low&&q.low[i],c=q.close&&q.close[i]; if([o,h,l,c].every(v=>typeof v==='number')) out.push({ time: ts[i], open:o*m, high:h*m, low:l*m, close:c*m}); }
                        if (out.length) { candleSeries.setData(out); window.tvChart = chart; }
                    }).catch(()=>{});
                });
            }
            initTradingChart(30);
            const tradingRange = document.querySelectorAll('.trading-range-btn');
            tradingRange.forEach(btn=>{
                btn.addEventListener('click', function(){
                    tradingRange.forEach(b=>b.classList.remove('active')); this.classList.add('active');
                    const days = parseInt(this.getAttribute('data-days'),10); initTradingChart(days);
                });
            });
            const modeGroup = document.getElementById('display-mode-group');
            if (modeGroup){
                const setMode = function(m){ try{ localStorage.setItem('price_display_mode', m); }catch(e){} updateCards(); const activeRangeBtn = document.querySelector('.time-range-btn.active'); const range = activeRangeBtn ? parseInt(activeRangeBtn.getAttribute('data-range'),10) : 7; renderTable(range); const actDaysBtn = document.querySelector('.trading-range-btn.active'); const days = actDaysBtn ? parseInt(actDaysBtn.getAttribute('data-days'),10) : 30; initTradingChart(days); };
                const cur = (localStorage.getItem('price_display_mode') || 'cfd');
                Array.from(modeGroup.querySelectorAll('button')).forEach(b=>{ b.classList.toggle('active', b.getAttribute('data-mode')===cur); });
                modeGroup.addEventListener('click', function(e){ const btn = e.target.closest('button[data-mode]'); if (!btn) return; Array.from(modeGroup.querySelectorAll('button')).forEach(b=>b.classList.remove('active')); btn.classList.add('active'); setMode(btn.getAttribute('data-mode')); });
            }
        });
    </script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6NYW2FSG2J"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);} 
        gtag('js', new Date());
        gtag('config', 'G-6NYW2FSG2J');
        gtag('config', 'G-DHFJF4DKPM');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6279351956858317" crossorigin="anonymous"></script>
</body>
</html>
    <!-- Lightweight Charts -->
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
